<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TopAI Mobile</title>
    
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

    <style>
        /* --- LE FIX POUR LES ÉCRITURES BIZARRES --- */
        py-loader, .py-error, .py-splash {
            display: none !important;
            visibility: hidden !important;
        }

        :root { --bg: #050505; --accent: #00ff41; --user-blue: #007bff; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; 
            background: var(--bg); color: white; margin: 0; 
            display: flex; flex-direction: column; height: 100vh;
        }

        /* Sidebar Mobile */
        #sidebar {
            position: fixed; left: 0; top: 0; bottom: 0; width: 280px;
            background: #111; z-index: 1000; transform: translateX(-100%);
            transition: 0.3s ease; border-right: 1px solid #333;
        }
        #sidebar.open { transform: translateX(0); }

        /* Header */
        header {
            padding: 15px; background: #111; border-bottom: 1px solid #222;
            display: flex; align-items: center; justify-content: space-between;
        }

        #chat-window {
            flex-grow: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 12px;
            -webkit-overflow-scrolling: touch; /* Scroll fluide iOS */
        }

        .message {
            max-width: 85%; padding: 12px 16px; border-radius: 18px;
            font-size: 15px; line-height: 1.5; word-wrap: break-word;
        }
        .user { align-self: flex-end; background: var(--user-blue); border-bottom-right-radius: 4px; }
        .ai { align-self: flex-start; background: #222; border: 1px solid #333; border-bottom-left-radius: 4px; }

        /* Input Zone Optimisée Mobile */
        #input-area {
            padding: 10px; background: #111; border-top: 1px solid #222;
            display: flex; gap: 8px; padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }

        input {
            flex-grow: 1; background: #1a1a1a; border: 1px solid #333;
            color: white; padding: 12px; border-radius: 25px; outline: none; font-size: 16px; /* Évite le zoom auto sur iOS */
        }

        button {
            background: var(--accent); color: black; border: none;
            padding: 0 20px; border-radius: 25px; font-weight: bold; cursor: pointer;
        }

        /* Overlay quand menu ouvert */
        #overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 999;
        }
        #overlay.active { display: block; }

        #loading-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div style="color:var(--accent); font-size: 24px; font-weight: bold;">TopAI</div>
        <div style="color:#666; margin-top: 10px;">Éveil des neurones...</div>
    </div>

    <div id="overlay"></div>

    <div id="sidebar">
        <div style="padding: 20px; border-bottom: 1px solid #333;">
            <h3>Historique</h3>
            <button onclick="location.reload()" style="width:100%; padding:10px;">+ Nouvelle Chat</button>
        </div>
        <ul id="history-list" style="padding:0; list-style:none;"></ul>
    </div>

    <header>
        <button id="menu-btn" style="background:none; border:none; color:white; font-size:24px;">☰</button>
        <div style="font-weight:bold;">TopAI <span style="color:var(--accent)">●</span></div>
        <div style="width:24px;"></div> </header>

    <div id="chat-window">
        <div class="message ai">Bonjour ! Je suis TopAI. Tape un mot pour commencer notre discussion illimitée.</div>
    </div>

    <div id="input-area">
        <input type="text" id="user-input" placeholder="Message...">
        <button id="send-btn" py-click="process_input">OK</button>
    </div>

    <py-script>
        import random
        from js import document, window

        corpus = "L'intelligence artificielle est un outil incroyable. TopAI fonctionne en local. Le futur est ici. C'est un projet de zinzin."
        
        # --- Moteur de génération simplifié ---
        words = corpus.split()
        chain = {}
        for i in range(len(words)-1):
            w1 = words[i]
            w2 = words[i+1]
            if w1 not in chain: chain[w1] = []
            chain[w1].append(w2)

        def add_msg(text, style):
            chat = document.getElementById("chat-window")
            div = document.createElement("div")
            div.className = f"message {style}"
            div.innerText = text
            chat.appendChild(div)
            chat.scrollTop = chat.scrollHeight

        def process_input(*args):
            inp = document.getElementById("user-input")
            val = inp.value.strip()
            if not val: return
            
            add_msg(val, "user")
            inp.value = ""

            # Génération d'une réponse "riche"
            res = []
            curr = random.choice(list(chain.keys()))
            for _ in range(15):
                res.append(curr)
                if curr in chain: curr = random.choice(chain[curr])
                else: break
            
            add_msg(" ".join(res), "ai")

        # Cacher le loader une fois prêt
        document.getElementById("loading-screen").style.display = "none"
    </py-script>

    <script>
        // Menu & UI Logic
        const menuBtn = document.getElementById('menu-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        function toggleMenu() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        menuBtn.onclick = toggleMenu;
        overlay.onclick = toggleMenu;

        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('send-btn').click();
        });
    </script>
</body>
</html>
